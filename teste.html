<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audios = document.querySelectorAll('audio');
        const btnLoop = document.getElementById('btnLoop');
        const btnText = btnLoop.querySelector('span');
        let isLooping = false;
        
        // Armazena o tempo de cada Ã¡udio para retomar depois
        const audioTimes = {};

        // FunÃ§Ã£o que para e "mata" a conexÃ£o dos outros Ã¡udios para liberar a banda
        function stopAndKillOthers(currentAudio) {
            audios.forEach((audio, index) => {
                if (audio !== currentAudio) {
                    // 1. Salva onde parou (para retomar)
                    if (!audio.paused && audio.currentTime > 0) {
                        audioTimes[index] = audio.currentTime;
                    }

                    // 2. Pausa
                    audio.pause();

                    // 3. MATA A CONEXÃƒO (Crucial para Streaming rÃ¡pido)
                    // Remove o src e forÃ§a o load() para o navegador parar de baixar este arquivo
                    if (audio.getAttribute('src')) {
                        audio.removeAttribute('src');
                        audio.load();
                    }

                    // 4. Restaura a capa visualmente
                    const wrapper = audio.parentElement;
                    const overlay = wrapper.querySelector('.player-overlay');
                    const textSpan = overlay.querySelector('span');
                    
                    if (overlay) {
                        overlay.classList.remove('hidden');
                        // Restaura texto original se existir
                        if (overlay.hasAttribute('data-original-text')) {
                            textSpan.textContent = overlay.getAttribute('data-original-text');
                        }
                    }
                }
            });
        }

        const overlays = document.querySelectorAll('.player-overlay');
        
        overlays.forEach((overlay, index) => {
            const audio = overlay.parentElement.querySelector('audio');
            const textSpan = overlay.querySelector('span');
            
            // Salva o texto original (ex: "â–¶ Play Verse 1")
            overlay.setAttribute('data-original-text', textSpan.textContent);

            overlay.addEventListener('click', function() {
                
                // --- PARTE CRÃTICA: Mata os outros downloads ---
                stopAndKillOthers(audio);

                // Feedback Visual RÃ¡pido
                textSpan.textContent = "âŒ› Loading...";
                
                // Injeta o Link e Inicia o Streaming
                if (!audio.getAttribute('src')) {
                    audio.src = audio.getAttribute('data-src');
                    
                    // LÃ³gica segura para retomar o tempo (Resume)
                    // SÃ³ definimos o tempo quando os metadados (duraÃ§Ã£o/formato) carregarem
                    if (audioTimes[index]) {
                        audio.addEventListener('loadedmetadata', function setTime() {
                            audio.currentTime = audioTimes[index];
                            // Remove o ouvinte para nÃ£o disparar de novo se o Ã¡udio recarregar
                            audio.removeEventListener('loadedmetadata', setTime);
                        }, { once: true });
                    }
                }
                
                // Tocar
                const playPromise = audio.play();

                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Sucesso: O buffering comeÃ§ou e o Ã¡udio vai tocar.
                        // Removemos o overlay imediatamente.
                        this.classList.add('hidden');
                    })
                    .catch(error => {
                        console.log("Erro ou bloqueio no play:", error);
                        textSpan.textContent = "âš ï¸ Error (Click again)";
                    });
                }
            });
        });

        // Loop
        btnLoop.addEventListener('click', function() {
            isLooping = !isLooping; 
            if (isLooping) {
                btnLoop.classList.add('active');
                btnText.textContent = "ðŸ” Auto Repeat: ON";
            } else {
                btnLoop.classList.remove('active');
                btnText.textContent = "ðŸ” Auto Repeat: OFF";
            }
            audios.forEach(audio => {
                audio.loop = isLooping;
            });
        });
    });
</script>
